# Django Deployment Master Guide
# Project: Christian Fundraising Foundation
# File: siteground_staging.txt
# Last Updated: [YYYY-MM-DD]

=============================================
1. PROJECT STRUCTURE
=============================================

1.1. Expected Project Structure
----------------------
project_root/
├── christianfoundation/      # Django project
│   ├── settings/
│   │   ├── base.py          # Shared settings
│   │   ├── development.py   # Local config
│   │   ├── production.py    # Final config
│   │   └── staging.py       # SiteGround staging
│   └── ...
├── static/                  # CSS/JS/fonts
│   └── media/				  # Static media
│       └── team/          
├── templates/               # HTML templates
└── manage.py

We have 3 configs in total to account for all environments separately. This maintains separation of concerns and allows for testing in two different environments before messing with production.

1.2. Staging Directory Structure
----------------------
staging
│   └── ...



=============================================
2. INITIAL SETUP (LOCAL)
=============================================

A. Configure Settings
----------------------
1. Create settings structure:
   mkdir -p christianfoundation/settings/
   touch christianfoundation/settings/{__init__,base,development,staging}.py

2. Update BASE_DIR in base.py:
   BASE_DIR = Path(__file__).resolve().parent.parent  # Points to christianfoundation/

B. Static/Media Setup
---------------------
# settings/base.py
STATIC_URL = "static/"
STATICFILES_DIRS = [
    BASE_DIR / "static",          # project_root/static/
    BASE_DIR / "blog/static",     # project_root/blog/static/
]
STATIC_ROOT = BASE_DIR / "staticfiles"  # for collectstatic
MEDIA_URL = "/media/"
MEDIA_ROOT = BASE_DIR / "static" / "media"

SEE -> image-organization-check.txt

=============================================
3. SITEGROUND STAGING DEPLOYMENT
=============================================

A. Preparation
--------------
1. Backup local data:
   python manage.py dumpdata --exclude auth.permission > staging_db.json
   tar -czvf staging_backup.tar.gz .

2. Configure settings/staging.py:
   from .base import *
   
   DEBUG = False
   ALLOWED_HOSTS = ['staging.yourdomain.com']
   DATABASES = {
       'default': {
           'ENGINE': 'django.db.backends.postgresql',
           'NAME': os.getenv('STAGING_DB_NAME'),
           'USER': os.getenv('STAGING_DB_USER'),
           'PASSWORD': os.getenv('STAGING_DB_PASSWORD'),
           'HOST': 'localhost',
           'PORT': '5432',
       }
   }

B. SiteGround Setup
-------------------
1. Create staging:
   - cPanel → Staging Tool → "Clean Install"
   - Domain: staging.yourdomain.com

2. Set environment variables:
   DJANGO_SETTINGS_MODULE=christianfoundation.settings.staging
   STAGING_DB_NAME=cf_staging_db
   STAGING_DB_USER=cf_staging_user
   STAGING_DB_PASSWORD=[YOUR_PASSWORD]

C. Deployment Commands
----------------------
# Upload code
rsync -avz --exclude '.env' ./ user@staging.yourdomain.com:~/staging.yourdomain.com

# On server:
python manage.py migrate
python manage.py loaddata staging_db.json
python manage.py collectstatic --noinput

=============================================
4. TEMPLATE MIGRATION TOOL
=============================================

Save as update_template_refs.py:
--------------------------------
import os
import re
from pathlib import Path

PROJECT_ROOT = Path(__file__).parent
TEMPLATES_DIR = PROJECT_ROOT / "templates"
OLD_PATTERN = r'\{% static [\'"]media/(.*?)[\'"] %\}'
NEW_PATTERN = r'{% static \'assets/images/\1\' %}' 

def update_templates():
    for file in TEMPLATES_DIR.rglob('*.html'):
        with open(file, 'r+', encoding='utf-8') as f:
            content = f.read()
            updated = re.sub(OLD_PATTERN, NEW_PATTERN, content)
            if updated != content:
                f.seek(0)
                f.write(updated)
                f.truncate()
                print(f"Updated {file}")

if __name__ == '__main__':
    update_templates()

Usage:
------
python update_template_refs.py

=============================================
5. TROUBLESHOOTING
=============================================

A. Templates Not Loading
------------------------
1. Verify:
   # settings/staging.py
   TEMPLATES = [{
       'DIRS': [BASE_DIR.parent / 'templates'],  # Absolute path
       ...
   }]

2. Check paths:
   python manage.py shell --settings=christianfoundation.settings.staging
   >>> from django.template.loader import get_template
   >>> print(get_template('index.html').origin)

B. Static Files 404
-------------------
1. Collect static:
   python manage.py collectstatic --noinput --settings=christianfoundation.settings.staging

2. Verify locations:
   python manage.py findstatic css/main.css --settings=christianfoundation.settings.staging

=============================================
6. TIME ESTIMATES
=============================================

| Task                          | Duration  |
|-------------------------------|-----------|
| Local settings configuration  | 30 min    |
| SiteGround staging setup      | 20 min    |
| Initial deployment            | 45 min    |
| Template migration            | 5 min     |
| Testing & fixes               | 30 min    |
| Total                         | 2-3 hours |

=============================================
7. MAINTENANCE SCRIPTS
=============================================

A. Automated Deployment (deploy_staging.sh)
-------------------------------------------
#!/bin/bash
rsync -avz \
  --exclude '.env' \
  --exclude '__pycache__' \
  ./ user@staging.yourdomain.com:~/staging.yourdomain.com

ssh user@staging.yourdomain.com "
  cd ~/staging.yourdomain.com
  source venv/bin/activate
  python manage.py collectstatic --noinput
"

B. Database Backup (backup_db.sh)
---------------------------------
#!/bin/bash
BACKUP_NAME="backup_$(date +%Y%m%d).json"
python manage.py dumpdata --exclude auth.permission > $BACKUP_NAME

=============================================
BEST PRACTICES
=============================================
1. Never share staging/production credentials
2. Test all changes in staging first
3. Keep backups before major changes
4. Document all deployment steps
5. Use version control for all changes
6. Monitor staging site performance
7. Schedule regular backups