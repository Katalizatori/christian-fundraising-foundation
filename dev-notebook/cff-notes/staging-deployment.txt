# SiteGround Staging Deployment Guide (Complete)
# Project: Christian Fundraising Foundation
# Version: 2.0
# Last Updated: 20-04-2025

=============================================
0. PREREQUISITES (COMPLETE LIST)
=============================================

0.1 Terminal Applications (All Platforms)
----------------------------------------

A. SSH Clients:
   â€¢ macOS/Linux:
     - Built-in Terminal app
     - Recommended: iTerm2 (https://iterm2.com/)
     
   â€¢ Windows:
     - PuTTY (https://www.putty.org/)
     - Windows Terminal (https://aka.ms/terminal) â˜…
     - MobaXterm (https://mobaxterm.mobatek.net/)

B. File Transfer Tools:
   â€¢ GUI Options:
     - FileZilla (Cross-platform)
     - WinSCP (Windows) â˜…
     - Cyberduck (macOS)
     
   â€¢ Command Line:
     - scp (Built-in on macOS/Linux)
     - rsync (Install via package manager)
     - curl (Built-in most systems)

C. Database Tools:
   â€¢ PostgreSQL:
     - psql client (Install via):
       macOS: brew install postgresql
       Ubuntu: sudo apt install postgresql-client-12
       Windows: https://www.enterprisedb.com/downloads/postgres-postgresql-downloads â˜…
     
     - pg_dump (Comes with PostgreSQL install)
     
   â€¢ MySQL (If applicable):
     - mysql client
     - mysqldump

D. Python Environment:
   â€¢ Python 3.8+ (https://www.python.org/downloads/)
   â€¢ pip (Python package manager)
   â€¢ virtualenv (pip install virtualenv)
   â€¢ pipenv (Optional: pip install pipenv)

E. Additional Utilities:
   â€¢ wget:
     macOS: brew install wget
     Ubuntu: sudo apt install wget
     
   â€¢ git (https://git-scm.com/downloads)
   â€¢ nano/vim (For file editing on server)

0.2 SiteGround-Specific Requirements
------------------------------------

1. Enable in Site Tools:
   â€¢ SSH Access (Site Tools â†’ Devs â†’ SSH)
   â€¢ Python Support (Site Tools â†’ Python)
   â€¢ Database Management (Site Tools â†’ Database)

2. Connection Details:
   â€¢ SSH Port: 18765 (Always)
   â€¢ SFTP Port: 18765
   â€¢ PostgreSQL Port: 18765
   â€¢ Hostname: yourdomain.com (NOT localhost)

3. Required Permissions:
   â€¢ Database modification rights
   â€¢ File system write access
   â€¢ Python environment creation

=============================================
1. EXISTING SITE PRESERVATION (COMPLETE)
=============================================

1.1 Comprehensive Backup Procedure
----------------------------------

A. File System Backup:

1. Connect via SFTP:
   sftp -P 18765 username@yourdomain.com

2. Create backup directory:
   mkdir ~/pre_deployment_backup

3. Download critical files:
   get -r public_html/wp-content/uploads/ ~/pre_deployment_backup/
   get -r public_html/media/ ~/pre_deployment_backup/
   get public_html/wp-config.php ~/pre_deployment_backup/
   get public_html/.htaccess ~/pre_deployment_backup/
   get public_html/robots.txt ~/pre_deployment_backup/
   get public_html/.env ~/pre_deployment_backup/

B. Database Backup:

1. For WordPress (MySQL):
   ssh -p 18765 username@yourdomain.com
   mysqldump -u dbuser -p dbname > ~/pre_deployment_backup/db_backup.sql

2. For Django (PostgreSQL):
   ssh -p 18765 username@yourdomain.com
   pg_dump -h localhost -p 18765 -U dbuser -d dbname > ~/pre_deployment_backup/db_backup.sql

C. Verification:

1. Check backup integrity:
   ls -lh ~/pre_deployment_backup/
   head -n 20 ~/pre_deployment_backup/db_backup.sql

1.2 Database Transition Plan
----------------------------

Option A: Rename Existing Database (If possible)
1. Connect to PostgreSQL:
   psql -h localhost -p 18765 -U current_user -d postgres

2. Execute rename:
   ALTER DATABASE current_db RENAME TO old_db_backup;

Option B: Schema Isolation (If rename not possible)
1. Create new schema:
   CREATE SCHEMA legacy_site;

2. Move existing tables:
   DO $$
   DECLARE
     r RECORD;
   BEGIN
     FOR r IN SELECT tablename FROM pg_tables WHERE schemaname = 'public'
     LOOP
       EXECUTE 'ALTER TABLE public.' || quote_ident(r.tablename) || ' SET SCHEMA legacy_site';
     END LOOP;
   END $$;

=============================================
2. DEPLOYMENT PROCESS (FULL DETAILS)
=============================================

2.1 Complete Code Transfer
--------------------------

A. Initial Transfer:
rsync -avz -e "ssh -p 18765" \
  --exclude '.git' \
  --exclude '.env' \
  --exclude '__pycache__' \
  --exclude 'media' \
  --exclude '*.sqlite3' \
  --exclude '.venv' \
  --progress \
  ./ username@yourdomain.com:~/public_html/

B. Permission Fixes:
ssh -p 18765 username@yourdomain.com
find public_html -type d -exec chmod 755 {} \;
find public_html -type f -exec chmod 644 {} \;
chmod 750 public_html
chmod +x public_html/manage.py

2.2 Database Migration
----------------------

A. Django-Specific:
ssh -p 18765 username@yourdomain.com
cd public_html
source venv/bin/activate
python manage.py migrate
python manage.py createsuperuser
python manage.py collectstatic --noinput

B. Environment Setup:
1. Create virtual environment:
   python -m venv venv
   
2. Install requirements:
   pip install -r requirements.txt

3. Set environment variables:
   echo "DJANGO_SETTINGS_MODULE=config.settings.production" >> .env
   echo "DATABASE_URL=postgres://user:pass@localhost:18765/dbname" >> .env

=============================================
3. POST-DEPLOYMENT (COMPLETE CHECKLIST)
=============================================

3.1 Verification Steps
----------------------

1. URL Checks:
   curl -I https://yourdomain.com
   curl https://yourdomain.com/admin/login/

2. Database Verification:
   psql -h localhost -p 18765 -U dbuser -d dbname -c "\dt"

3. Error Logs:
   tail -n 100 ~/logs/python_errors.log
   cat ~/logs/access_log | grep 500

3.2 Rollback Procedure
----------------------

A. File System Rollback:
ssh -p 18765 username@yourdomain.com
rm -rf public_html/*
cp -r ~/pre_deployment_backup/* public_html/

B. Database Rollback:
psql -h localhost -p 18765 -U dbuser -d dbname < ~/pre_deployment_backup/db_backup.sql

C. Schema Cleanup:
DROP SCHEMA IF EXISTS legacy_site CASCADE;

=============================================
4. TROUBLESHOOTING (COMPREHENSIVE)
=============================================

4.1 Common Errors and Solutions
-------------------------------

A. Connection Issues:
   ðŸ”´ "Connection refused" on port 22
   â†’ Always use port 18765 with SiteGround
   â†’ Verify SSH access in Site Tools

   ðŸ”´ "Permission denied (publickey)"
   â†’ Ensure password authentication is enabled
   â†’ Contact SiteGround support to reset SSH

B. Database Errors:
   ðŸ”´ "FATAL: remaining connection slots are reserved"
   â†’ Add this to settings.py:
     'OPTIONS': {
         'options': '-c statement_timeout=3000 -c idle_in_transaction_session_timeout=3000'
     }

   ðŸ”´ "psql: FATAL: database does not exist"
   â†’ Verify database name in Site Tools
   â†’ SiteGround databases have username_ prefix

C. Python Errors:
   ðŸ”´ "ModuleNotFoundError"
   â†’ Verify virtual environment activation
   â†’ Check requirements.txt installation

   ðŸ”´ "502 Bad Gateway"
   â†’ Check Python application server status
   â†’ Verify WSGI configuration

4.2 SiteGround-Specific Issues
------------------------------

1. Python Version Mismatch:
   â€¢ Set exact version in Site Tools â†’ Python
   â€¢ Verify with: python --version

2. Memory Limits:
   â€¢ Add to settings.py:
     import resource
     resource.setrlimit(resource.RLIMIT_AS, (512000000, 512000000))

3. Cron Job Setup:
   â€¢ Use Site Tools â†’ Cron Jobs
   â€¢ Example backup cron:
     0 3 * * * pg_dump -h localhost -p 18765 -U user dbname > ~/backup.sql

=============================================
5. APPENDICES
=============================================

5.1 Complete Command Reference
------------------------------

A. Database:
   â€¢ Create user: CREATE USER newuser WITH PASSWORD 'password';
   â€¢ Grant privileges: GRANT ALL PRIVILEGES ON DATABASE dbname TO newuser;

B. System:
   â€¢ Disk usage: du -sh *
   â€¢ Memory: free -m
   â€¢ Processes: htop

5.2 Contact Information
-----------------------
â€¢ SiteGround Support: support@siteground.com
â€¢ SSH Emergency Reset: Site Tools â†’ Devs â†’ SSH
â€¢ Database Recovery: Site Tools â†’ Database â†’ Backups

5.3 Change Log
--------------
â€¢ 20-04-2025: Added complete prerequisite section
â€¢ 20-04-2025: Detailed rollback procedures
â€¢ 20-04-2025: SiteGround-specific port documentation